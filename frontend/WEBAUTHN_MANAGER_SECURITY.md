# WebAuthnManager Security Implementation

## Overview

The `WebAuthnManager` class provides secure encapsulation of WASM workers that can only be accessed after successful WebAuthn challenges. WASM workers derive NEAR keys from WebAuthn challenges and sign transactions.

**Key Features:**
- **Server-Generated Challenges**: Passkey WebAuthn with server challenges
- **Zero Direct Worker Access**: Complete encapsulation of sensitive operations
- **One-Time Workers**: Each worker processes one operation then self-terminates
- **Challenge Validation**: Single-use, time-limited, operation-specific challenges
- **WASM Key Generation**: Private key generation: Happens entirely in WASM (isolated sandbox)
- **Encryption**: Uses HKDF-SHA256 with fixed salts, encrypted keys stored in origin-scoped IndexedDB

## Security Architecture

1. **Server Challenge Integration**: All challenges generated by WebAuthn server
3. **Single-Use Validation**: Each challenge consumed exactly once
5. **Worker Encapsulation**: No direct worker access outside WebAuthnManager
7. **WASM Isolation**: Private key generation happens in WASM sandbox, atomic with encryption

## API Flow

### Registration
```typescript
// 1. Get server challenge
const { options, challengeId } = await webAuthnManager.getRegistrationOptions(username);

// 2. WebAuthn ceremony with server challenge
const credential = await navigator.credentials.create({
  publicKey: { ...options, challenge: bufferDecode(options.challenge) }
});

// 3. Secure worker operation
const result = await webAuthnManager.secureRegistration(
  publicKeyCredentialToJSON(credential),
  { nearPrivateKeyString, derpAccountId },
  challengeId
);
```

### Transaction Signing
```typescript
// 1. Get server challenge
const { options, challengeId } = await webAuthnManager.getAuthenticationOptions(username);

// 2. WebAuthn ceremony with server challenge
const assertion = await navigator.credentials.get({
  publicKey: {
    challenge: bufferDecode(options.challenge),
    // ... other server options
  }
});

// 3. Secure worker operation
const result = await webAuthnManager.secureTransactionSigning(
  publicKeyCredentialToJSON(assertion),
  { derpAccountId, receiverId, contractMethodName, ... },
  challengeId
);
```

## Security Benefits

- **XSS Protection**: Workers inaccessible without valid WebAuthn + server challenges
- **Replay Prevention**: Single-use server challenges
- **Timeout Protection**: 30-second operation timeouts
- **Proper WebAuthn**: Server-generated challenges with correct entropy
- **Key Security**: Private keys never exist in JavaScript memory
- **Atomic Operations**: Key generation + encryption happens atomically in WASM

## Testing

- `/test-onetime-worker`: Worker lifecycle validation
- `/test-webauthn-manager`: Security feature testing with server integration
