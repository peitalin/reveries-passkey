# WebAuthnManager Security Implementation (PRF-Only)

## Overview

The `WebAuthnManager` class provides secure encapsulation of WASM workers that can only be accessed after successful WebAuthn challenges. WASM workers derive NEAR keys from WebAuthn PRF (Pseudo-Random Function) outputs and sign transactions.

**Key Features:**
- **PRF-Based Key Derivation**: Uses WebAuthn PRF extension for enhanced security.
- **Server-Generated Challenges**: Passkey WebAuthn with server challenges.
- **Zero Direct Worker Access**: Complete encapsulation of sensitive operations.
- **One-Time Workers**: Each worker processes one operation then self-terminates.
- **Challenge Validation**: Single-use, time-limited, operation-specific challenges.
- **WASM Key Generation**: Private key generation happens entirely in WASM (isolated sandbox).
- **Encryption**: Uses PRF output with HKDF-SHA256, encrypted keys stored in origin-scoped IndexedDB.

## Security Architecture

1. **PRF Extension**: Leverages the WebAuthn PRF extension for deriving cryptographic keys directly from the authenticator.
2. **Server Challenge Integration**: All challenges generated by WebAuthn server.
3. **Single-Use Validation**: Each challenge consumed exactly once.
4. **Worker Encapsulation**: No direct worker access outside WebAuthnManager.
5. **WASM Isolation**: Private key generation happens in WASM sandbox, atomic with encryption.

## API Flow

### Registration (with PRF)
```typescript
// 1. Initiate PRF-enabled registration
const { credential, prfEnabled, challengeId } = await webAuthnManager.registerWithPrf(username);

// 2. (If prfEnabled and PRF output available from registration)
// OR Perform authentication to get PRF output
const { prfOutput } = await webAuthnManager.authenticateWithPrf(username, 'encryption');

// 3. Secure worker operation with PRF output
const result = await webAuthnManager.secureRegistrationWithPrf(
  username,
  prfOutput, // Or prfOutput from registration credential extensions
  { nearAccountId },
  challengeId, // Original registration challenge ID
  true // Skip challenge validation if PRF output was from a separate auth
);
```

### Transaction Signing (with PRF)
```typescript
// 1. Authenticate with PRF to get PRF output and challengeId
const { credential, prfOutput, challengeId } = await webAuthnManager.authenticateWithPrf(username, 'signing');

// 2. Secure worker operation with PRF output
const result = await webAuthnManager.secureTransactionSigningWithPrf(
  username,
  prfOutput,
  { nearAccountId, receiverId, contractMethodName, ... },
  challengeId
);
```

## Security Benefits

- **No Stored KDF Inputs**: PRF eliminates the need to store registration-time artifacts for key derivation.
- **Enhanced Key Security**: Keys are derived directly from authenticator's secret material via PRF.
- **XSS Protection**: Workers inaccessible without valid WebAuthn + server challenges.
- **Replay Prevention**: Single-use server challenges.
- **Timeout Protection**: 30-second operation timeouts.
- **Proper WebAuthn**: Server-generated challenges with correct entropy.
- **Key Security**: Private keys never exist in JavaScript memory.
- **Atomic Operations**: Key generation + encryption happens atomically in WASM.

## Testing

- `/test-onetime-worker`: Worker lifecycle validation (ensure it's updated for PRF).
- `/test-webauthn-manager`: Security feature testing with server integration (ensure it's updated for PRF).
